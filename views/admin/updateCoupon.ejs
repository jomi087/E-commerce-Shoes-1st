<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Feet</title>
    <!-- font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Moul&display=swap" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- my-css -->
    <style>
         body{
            color: white;
        }

        .swal2-custom-font {
            font-family: 'Poppins', sans-serif; 
            font-size: 12px; 
            font-weight: 300; 
        }

        .page-body {
        background-color: rgb(112, 109, 109);
        font-family: 'Cinzel Decorative', cursive;
        }
        
        .sidebar {
            height: 100vh;
            background-color: #a60000;
            border-right: 1px solid black;
            color: #ffffff;
        }

        .sidebar .nav-link {
            color: #ffffff;
        }

        .sidebar .nav-link.active {
            background-color: #ffffff;
            color: #000;
        }

        .content {
            padding: 20px;
        }

        .stats-card {
            background-color: #f6f0f0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stats-card h4 {
            margin: 0;
            font-size: 24px;
        }

        .graph-card {
            background-color: #f6f0f0e0;
            border-radius: 10px;
            padding: 20px;
            height: 300px;
        }

        .recent-sales {
            background-color: #f6f0f0e0;
            border-radius: 10px;
            padding: 20px;
            height: 300px;
        }

        .nav-bar-custom {
            background-color: #000000;
        }

        .nav-bar-custom .navbar-nav .nav-link {
            color: #fff;
        }

        .cinzel-decorative {
            font-family: "Cinzel Decorative";
            font-weight: 400;
            font-style: normal;
        }
    </style>
</head>

<body class="page-body">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg nav-bar-custom">
        <div class="container-fluid">
            <h3 class="text-white cinzel-decorative mt-2">Fashion Feet</h3>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Account</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/logout">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-3">
                <nav class="nav flex-column">
                    <a class="btn btn-primary nav-link" href="/admin/dashboard">Dashboard</a>
                    <a class="btn btn-primary nav-link" href="/admin/customer">Customers</a>
                    <a class="btn btn-primary nav-link" href="/admin/product">Products</a>
                    <a class="btn btn-primary nav-link" href="#">Orders</a>
                    <a class="btn btn-primary nav-link" href="#">Banner Management</a>
                    <a class="btn btn-primary nav-link" href="/admin/couponManagement">Coupon Management</a>
                    <a class="btn btn-primary nav-link" href="/admin/salesReport">Sales Report</a>
                    <a class="btn btn-primary nav-link" href="/admin/category">Category</a>
                </nav>
            </div>

            <!-- Content area -->
            <div class="col-md-8 content">
                <div class="row ">
                    <h3 class="border-bottom pb-1 offset-md-1">  Edit Coupon </h3>
                    <div class=" col-md-10 offset-md-2 mt-5 card p-5 fw-b">
                        <form id="editCouponForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editcouponCode" class="form-label fw-bold">Coupon Code</label>
                                    <input type="text" class="form-control" id="editcouponCode" placeholder="Enter coupon code" value="<%=coupon.code%>" >
                                    <span class="text-danger" id="couponCodeError"></span>
                                </div>
                                <div class="col-md-6">
                                    <label for="editdiscountAmount" class="form-label fw-bold">Discount (%)</label>
                                    <input type="number" class="form-control" id="editdiscountAmount" placeholder="Enter discount percentage" value="<%=coupon.discountPercentage%>" >
                                    <span class="text-danger" id="discountError"></span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editminPurchaseAmount" class="form-label fw-bold">Minimum Purchase Amount</label>
                                    <input type="number" class="form-control" id="editminPurchaseAmount" placeholder="Minimum purchase amount" value="<%=coupon.minPurchaseAmount%>">
                                    <span class="text-danger" id="minPurchaseAmountError"></span>
                                </div>
                                <div class="col-md-6">
                                    <label for="editmaxCapAmount" class="form-label fw-bold">Maximum Cap Amount</label>
                                    <input type="number" class="form-control" id="editmaxCapAmount" placeholder="Max Cap amount" value="<%=coupon.maxCapAmount%>">
                                    <span class="text-danger" id="maxCapAmountError"></span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editusageLimit" class="form-label fw-bold">Usage Limit</label>
                                    <input type="number" class="form-control" id="editusageLimit" placeholder="Max usage limit" value="<%=coupon.usageLimit%>">
                                    <span class="text-danger" id="usageLimitError"></span>
                                </div>
                            </div>
                            
                            <input type="hidden" id="couponId" value="<%=coupon._id%>" >

                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">Update Coupon</button>
                            </div>
                        </form>   
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <script>

    document.getElementById('editCouponForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const editcouponCode = document.getElementById('editcouponCode').value.trim();
        const editdiscountAmount = document.getElementById('editdiscountAmount').value.trim();
        const editminPurchaseAmount = document.getElementById('editminPurchaseAmount').value.trim();
        const editmaxCapAmount = document.getElementById('editmaxCapAmount').value.trim();
        const editusageLimit = document.getElementById('editusageLimit').value.trim();
        const couponId = document.getElementById('couponId').value;
        // console.log(couponId)

        let isValid = true;

        document.getElementById('couponCodeError').textContent = '';
        document.getElementById('discountError').textContent = '';
        document.getElementById('minPurchaseAmountError').textContent = '';
        document.getElementById('maxCapAmountError').textContent = '';
        document.getElementById('usageLimitError').textContent = '';

        if (!editcouponCode) {
            document.getElementById('couponCodeError').textContent = 'Coupon code is required';
            isValid = false;
        }else if (!/^[A-Z][A-Z0-9]*$/.test(editcouponCode)) {
            document.getElementById('couponCodeError').textContent = 'code must start with a letter & it should Only contain uppercase letters and numbers.';
            isValid = false;
        }

        if (editdiscountAmount === '' || parseInt(editdiscountAmount) < 0 || parseInt(editdiscountAmount) > 90 ) {
            document.getElementById('discountError').textContent = 'Please enter a valid discount percentage (0-100)';
            isValid = false;
        }

        if (!editminPurchaseAmount) {
            document.getElementById('minPurchaseAmountError').textContent = 'Minimum purchase amount is required';
            isValid = false;
        } else if (parseInt(editminPurchaseAmount) <= 0) { 
            document.getElementById('minPurchaseAmountError').textContent = 'Minimum purchase amount must be greater than 0';
            isValid = false;
        }

        if (!editmaxCapAmount) {
            document.getElementById('maxCapAmountError').textContent = 'Max Cap amount is required';
            isValid = false;
        } else if (parseInt(editmaxCapAmount) <= 0) { 
            document.getElementById('maxCapAmountError').textContent = 'Max Cap amount must be greater than 0';
            isValid = false;
        } 


        if (!editusageLimit) {
            document.getElementById('usageLimitError').textContent = 'Usage limit is required';
            isValid = false;
        } else if(parseInt(editusageLimit) <= 0){
            document.getElementById('usageLimitError').textContent = 'Usage limit is must be gretor than zero';
            isValid = false;
        }

        if (isValid) {
                try {
                    console.log('entered')
                    const response = await fetch('/admin/editCoupon',{
                        method : 'PATCH',
                        headers : {
                            'Content-type' : 'application/json'
                        },
                        body: JSON.stringify({
                            couponId,
                            editcouponCode,
                            editdiscountAmount,
                            editminPurchaseAmount,
                            editmaxCapAmount,
                            editusageLimit,
                        })
                    })

                    const result  = await response.json()

                    if(result.success){
                        window.location.href = '/admin/couponManagement'

                    }else{
                        Swal.fire({
                            icon: 'error',
                            toast: true,
                            position: 'top-end',
                            background: '#f8d7da',
                            customClass: {
                                popup: 'swal2-custom-font', 
                            },
                            width: '280px', 
                            text: result.message||'Please try again later.',
                            showConfirmButton: false,
                            timerProgressBar: true,
                            timer: 1500,
                        })
                    }

                } catch (error) {
                    console.log(error);
                    Swal.fire({
                        icon: 'error',
                        toast: true,
                        position: 'top-end',
                        background: '#f8d7da',
                        customClass: {
                            popup: 'swal2-custom-font', // Custom class for font styling
                        },
                        width: '280px', 
                        text: 'Something went wrong. Please try again later.',
                        showConfirmButton: false,
                        timerProgressBar: true,
                        timer: 1500,
                    })
                }
            }
    })


    </script>

</body>

</html>
